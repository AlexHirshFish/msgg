<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messenger - –í—Ö–æ–¥</title>
    
    <!-- VKUI CSS -->
    <link rel="stylesheet" href="https://unpkg.com/@vkontakte/vkui/dist/vkui.css">
</head>
<body>
    <div id="root"></div>

    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel –¥–ª—è JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- VKUI -->
    <script src="https://unpkg.com/@vkontakte/vkui/dist/vkui.js"></script>

    <script type="text/babel">
        const { 
            AdaptivityProvider, 
            ConfigProvider, 
            AppRoot, 
            SplitLayout, 
            SplitCol, 
            View, 
            Panel, 
            PanelHeader, 
            FormLayout, 
            FormItem, 
            Input, 
            Button, 
            Group, 
            Div, 
            Title, 
            Text, 
            Link,
            Snackbar,
            Avatar,
            CellButton,
            Separator,
            PanelHeaderBack
        } = VKUI;

        // –ü–æ–ª—É—á–∞–µ–º –∏–∫–æ–Ω–∫–∏ –∏–∑ VKUI
        const VKIcons = VKUI.VKIcons || {};
        const Icon24User = VKIcons.Icon24User || (() => React.createElement('span', null, 'üë§'));
        const Icon24Mail = VKIcons.Icon24Mail || (() => React.createElement('span', null, '‚úâÔ∏è'));
        const Icon24Lock = VKIcons.Icon24Lock || (() => React.createElement('span', null, 'üîí'));
        const Icon24Phone = VKIcons.Icon24Phone || (() => React.createElement('span', null, 'üì±'));
        const Icon24Chevron = VKIcons.Icon24Chevron || (() => React.createElement('span', null, '-chevron'));

        class MessengerApp extends React.Component {
            constructor(props) {
                super(props);
                this.state = {
                    activeView: 'login',
                    phone: '',
                    email: '',
                    password: '',
                    firstName: '',
                    lastName: '',
                    verificationCode: '',
                    identifier: '',
                    isLoading: false,
                    error: '',
                    success: '',
                    showVerificationStep: false
                };
            }

            handleInputChange = (field, value) => {
                this.setState({
                    [field]: value,
                    error: '',
                    success: ''
                });
            };

            validatePhone = (phone) => {
                const cleaned = phone.replace(/\D/g, '');
                return cleaned.length >= 10;
            };

            sendVerificationCode = async () => {
                if (!this.validatePhone(this.state.phone)) {
                    this.setState({ error: '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞' });
                    return;
                }

                this.setState({ isLoading: true });

                try {
                    const response = await fetch('/api/auth.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'send_verification',
                            phone: this.state.phone
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.setState({
                            success: '–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω',
                            showVerificationStep: true,
                            isLoading: false
                        });
                    } else {
                        this.setState({
                            error: data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞',
                            isLoading: false
                        });
                    }
                } catch (error) {
                    this.setState({
                        error: '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏',
                        isLoading: false
                    });
                }
            };

            register = async () => {
                if (!this.state.firstName || !this.state.lastName || !this.state.email || !this.state.password || !this.state.verificationCode) {
                    this.setState({ error: '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è' });
                    return;
                }

                this.setState({ isLoading: true });

                try {
                    const response = await fetch('/api/auth.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'register',
                            phone: this.state.phone,
                            email: this.state.email,
                            password: this.state.password,
                            first_name: this.state.firstName,
                            last_name: this.state.lastName,
                            verification_code: this.state.verificationCode
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('user', JSON.stringify(data.user));
                        window.location.href = 'messenger.html';
                    } else {
                        this.setState({
                            error: data.error || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏',
                            isLoading: false
                        });
                    }
                } catch (error) {
                    this.setState({
                        error: '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏',
                        isLoading: false
                    });
                }
            };

            login = async () => {
                if (!this.state.identifier || !this.state.password) {
                    this.setState({ error: '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å' });
                    return;
                }

                this.setState({ isLoading: true });

                try {
                    const response = await fetch('/api/auth.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'login',
                            identifier: this.state.identifier,
                            password: this.state.password
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('user', JSON.stringify(data.user));
                        window.location.href = 'messenger.html';
                    } else {
                        this.setState({
                            error: data.error || '–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ',
                            isLoading: false
                        });
                    }
                } catch (error) {
                    this.setState({
                        error: '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏',
                        isLoading: false
                    });
                }
            };

            handleTelegramLogin = () => {
                // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram Login Widget
                alert('Telegram login –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –æ—Ç–¥–µ–ª—å–Ω–æ');
            };

            renderLoginForm = () => (
                <FormLayout>
                    <FormItem top="–¢–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ Email">
                        <Input
                            type="text"
                            placeholder="+7 999 123-45-67 –∏–ª–∏ email@example.com"
                            value={this.state.identifier}
                            onChange={(e) => this.handleInputChange('identifier', e.target.value)}
                            before={React.createElement(Icon24User)}
                        />
                    </FormItem>
                    
                    <FormItem top="–ü–∞—Ä–æ–ª—å">
                        <Input
                            type="password"
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
                            value={this.state.password}
                            onChange={(e) => this.handleInputChange('password', e.target.value)}
                            before={React.createElement(Icon24Lock)}
                        />
                    </FormItem>
                    
                    {this.state.error && (
                        <Div style={{color: '#e64646', fontSize: '14px', marginTop: '8px'}}>
                            {this.state.error}
                        </Div>
                    )}
                    
                    {this.state.success && (
                        <Div style={{color: '#4bb34b', fontSize: '14px', marginTop: '8px'}}>
                            {this.state.success}
                        </Div>
                    )}
                    
                    <FormItem>
                        <Button
                            size="l"
                            stretched
                            loading={this.state.isLoading}
                            onClick={this.login}
                        >
                            –í–æ–π—Ç–∏
                        </Button>
                    </FormItem>
                    
                    <FormItem>
                        <Button
                            size="l"
                            stretched
                            mode="secondary"
                            onClick={() => this.setState({ activeView: 'register' })}
                        >
                            –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                        </Button>
                    </FormItem>
                    
                    <Separator style={{ margin: '20px 0' }} />
                    
                    <FormItem>
                        <Button
                            size="l"
                            stretched
                            mode="tertiary"
                            before={React.createElement('img', {src: 'https://telegram.org/img/t_logo.png', width: '20', height: '20', alt: 'Telegram'})}
                            onClick={this.handleTelegramLogin}
                        >
                            –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram
                        </Button>
                    </FormItem>
                </FormLayout>
            );

            renderRegisterForm = () => (
                <FormLayout>
                    {!this.state.showVerificationStep ? (
                        <>
                            <FormItem top="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
                                <Input
                                    type="tel"
                                    placeholder="+7 999 123-45-67"
                                    value={this.state.phone}
                                    onChange={(e) => this.handleInputChange('phone', e.target.value)}
                                    before={React.createElement(Icon24Phone)}
                                />
                            </FormItem>
                            
                            <FormItem>
                                <Button
                                    size="l"
                                    stretched
                                    disabled={!this.validatePhone(this.state.phone)}
                                    loading={this.state.isLoading}
                                    onClick={this.sendVerificationCode}
                                >
                                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥
                                </Button>
                            </FormItem>
                        </>
                    ) : (
                        <>
                            <FormItem top="–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è">
                                <Input
                                    type="text"
                                    placeholder="–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥"
                                    value={this.state.verificationCode}
                                    onChange={(e) => this.handleInputChange('verificationCode', e.target.value)}
                                />
                            </FormItem>
                            
                            <FormItem top="Email">
                                <Input
                                    type="email"
                                    placeholder="email@example.com"
                                    value={this.state.email}
                                    onChange={(e) => this.handleInputChange('email', e.target.value)}
                                    before={React.createElement(Icon24Mail)}
                                />
                            </FormItem>
                            
                            <FormItem top="–ò–º—è">
                                <Input
                                    type="text"
                                    placeholder="–í–∞—à–µ –∏–º—è"
                                    value={this.state.firstName}
                                    onChange={(e) => this.handleInputChange('firstName', e.target.value)}
                                />
                            </FormItem>
                            
                            <FormItem top="–§–∞–º–∏–ª–∏—è">
                                <Input
                                    type="text"
                                    placeholder="–í–∞—à–∞ —Ñ–∞–º–∏–ª–∏—è"
                                    value={this.state.lastName}
                                    onChange={(e) => this.handleInputChange('lastName', e.target.value)}
                                />
                            </FormItem>
                            
                            <FormItem top="–ü–∞—Ä–æ–ª—å">
                                <Input
                                    type="password"
                                    placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤"
                                    value={this.state.password}
                                    onChange={(e) => this.handleInputChange('password', e.target.value)}
                                    before={React.createElement(Icon24Lock)}
                                />
                            </FormItem>
                            
                            <FormItem>
                                <Button
                                    size="l"
                                    stretched
                                    loading={this.state.isLoading}
                                    onClick={this.register}
                                >
                                    –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                                </Button>
                            </FormItem>
                        </>
                    )}
                    
                    {this.state.error && (
                        <Div style={{color: '#e64646', fontSize: '14px', marginTop: '8px'}}>
                            {this.state.error}
                        </Div>
                    )}
                    
                    {this.state.success && (
                        <Div style={{color: '#4bb34b', fontSize: '14px', marginTop: '8px'}}>
                            {this.state.success}
                        </Div>
                    )}
                    
                    <FormItem>
                        <Button
                            size="l"
                            stretched
                            mode="tertiary"
                            onClick={() => this.setState({ activeView: 'login', showVerificationStep: false })}
                        >
                            –ù–∞–∑–∞–¥ –∫ –≤—Ö–æ–¥—É
                        </Button>
                    </FormItem>
                </FormLayout>
            );

            render() {
                return (
                    <ConfigProvider>
                        <AdaptivityProvider>
                            <AppRoot>
                                <SplitLayout header={<PanelHeader separator={false} />}>
                                    <SplitCol spaced>
                                        <View activePanel={this.state.activeView}>
                                            <Panel id="login">
                                                <PanelHeader>–í—Ö–æ–¥ –≤ Messenger</PanelHeader>
                                                <Group>
                                                    <Div style={{textAlign: 'center', marginBottom: '30px'}}>
                                                        <Title level="1" style={{color: '#2688eb'}}>Messenger</Title>
                                                        <Text>–ë—ã—Å—Ç—Ä—ã–µ –∏ –Ω–∞–¥–µ–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</Text>
                                                    </Div>
                                                    {this.renderLoginForm()}
                                                </Group>
                                            </Panel>
                                            
                                            <Panel id="register">
                                                <PanelHeader 
                                                    separator={false}
                                                    before={
                                                        React.createElement(PanelHeaderBack, {
                                                            onClick: () => this.setState({ activeView: 'login', showVerificationStep: false })
                                                        })
                                                    }
                                                >
                                                    –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                                                </PanelHeader>
                                                <Group>
                                                    <Div style={{textAlign: 'center', marginBottom: '30px'}}>
                                                        <Title level="2">–°–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç</Title>
                                                    </Div>
                                                    {this.renderRegisterForm()}
                                                </Group>
                                            </Panel>
                                        </View>
                                    </SplitCol>
                                </SplitLayout>
                            </AppRoot>
                        </AdaptivityProvider>
                    </ConfigProvider>
                );
            }
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(React.createElement(MessengerApp));
    </script>
</body>
</html>