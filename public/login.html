<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messenger - Вход</title>
    
    <!-- VKUI CSS -->
    <link rel="stylesheet" href="https://unpkg.com/@vkontakte/vkui@6.0.0/dist/vkui.css">
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #fff;
        }
        
        .vkui__root {
            height: 100vh;
        }
        
        .login-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo h1 {
            color: #2688eb;
            margin: 0;
            font-size: 28px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .error-message {
            color: #e64646;
            font-size: 14px;
            margin-top: 8px;
        }
        
        .success-message {
            color: #4bb34b;
            font-size: 14px;
            margin-top: 8px;
        }
        
        .divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
            color: #818c99;
        }
        
        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e1e3e6;
            z-index: 1;
        }
        
        .divider span {
            position: relative;
            background: white;
            z-index: 2;
            padding: 0 10px;
        }
        
        .telegram-login {
            width: 100%;
            padding: 10px;
            background: #2aabee;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .switch-view {
            margin-top: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="root" class="vkui__root">
        <div class="login-container">
            <div class="logo">
                <h1>Messenger</h1>
                <p>Быстрые и надежные сообщения</p>
            </div>

            <div id="login-form">
                <div class="form-group">
                    <label>Телефон или Email</label>
                    <input 
                        type="text" 
                        id="login-identifier" 
                        placeholder="+7 999 123-45-67 или email@example.com"
                        class="vkui__input"
                    />
                </div>

                <div class="form-group">
                    <label>Пароль</label>
                    <input 
                        type="password" 
                        id="login-password" 
                        placeholder="Введите пароль"
                        class="vkui__input"
                    />
                </div>

                <div id="login-error" class="error-message" style="display: none;"></div>
                <div id="login-success" class="success-message" style="display: none;"></div>

                <button type="button" id="login-btn" class="vkui__button">
                    Войти
                </button>
                
                <div class="switch-view">
                    <button type="button" id="show-register-btn" class="vkui__button vkui__button--mode-secondary">
                        Регистрация
                    </button>
                </div>
            </div>

            <div id="register-form" style="display: none;">
                <div class="form-group">
                    <label>Номер телефона</label>
                    <input 
                        type="tel" 
                        id="register-phone" 
                        placeholder="+7 999 123-45-67"
                        class="vkui__input"
                    />
                </div>

                <button 
                    type="button" 
                    id="send-verification-btn"
                    class="vkui__button"
                    style="display: block; margin: 0 auto 16px;"
                >
                    Отправить код
                </button>

                <div id="verification-step" style="display: none;">
                    <div class="form-group">
                        <label>Код подтверждения</label>
                        <input 
                            type="text" 
                            id="verification-code" 
                            placeholder="Введите 6-значный код"
                            class="vkui__input"
                        />
                    </div>

                    <div class="form-group">
                        <label>Email</label>
                        <input 
                            type="email" 
                            id="register-email" 
                            placeholder="email@example.com"
                            class="vkui__input"
                        />
                    </div>

                    <div class="form-group">
                        <label>Имя</label>
                        <input 
                            type="text" 
                            id="register-first-name" 
                            placeholder="Ваше имя"
                            class="vkui__input"
                        />
                    </div>

                    <div class="form-group">
                        <label>Фамилия</label>
                        <input 
                            type="text" 
                            id="register-last-name" 
                            placeholder="Ваша фамилия"
                            class="vkui__input"
                        />
                    </div>

                    <div class="form-group">
                        <label>Пароль</label>
                        <input 
                            type="password" 
                            id="register-password" 
                            placeholder="Минимум 6 символов"
                            class="vkui__input"
                        />
                    </div>

                    <div id="register-error" class="error-message" style="display: none;"></div>
                    <div id="register-success" class="success-message" style="display: none;"></div>

                    <button type="button" id="register-btn" class="vkui__button">
                        Зарегистрироваться
                    </button>
                </div>
                
                <div class="switch-view">
                    <button type="button" id="show-login-btn" class="vkui__button vkui__button--mode-secondary">
                        Назад к входу
                    </button>
                </div>
            </div>

            <div class="divider">
                <span>или</span>
            </div>

            <button class="telegram-login" id="telegram-login-btn">
                Войти через Telegram
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Состояние приложения
            const state = {
                activeView: 'login',
                phone: '',
                email: '',
                password: '',
                firstName: '',
                lastName: '',
                verificationCode: '',
                identifier: '',
                isLoading: false,
                error: '',
                success: '',
                showVerificationStep: false
            };

            // Элементы формы
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const showRegisterBtn = document.getElementById('show-register-btn');
            const showLoginBtn = document.getElementById('show-login-btn');
            const sendVerificationBtn = document.getElementById('send-verification-btn');
            const verificationStep = document.getElementById('verification-step');
            const loginBtn = document.getElementById('login-btn');
            const registerBtn = document.getElementById('register-btn');
            const telegramLoginBtn = document.getElementById('telegram-login-btn');

            // Поля формы
            const loginIdentifier = document.getElementById('login-identifier');
            const loginPassword = document.getElementById('login-password');
            const registerPhone = document.getElementById('register-phone');
            const verificationCode = document.getElementById('verification-code');
            const registerEmail = document.getElementById('register-email');
            const registerFirstName = document.getElementById('register-first-name');
            const registerLastName = document.getElementById('register-last-name');
            const registerPassword = document.getElementById('register-password');

            // Обработчики событий
            showRegisterBtn.addEventListener('click', function() {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
            });

            showLoginBtn.addEventListener('click', function() {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                verificationStep.style.display = 'none';
            });

            sendVerificationBtn.addEventListener('click', async function() {
                const phone = registerPhone.value.trim();
                if (!validatePhone(phone)) {
                    showError('register-error', 'Введите корректный номер телефона');
                    return;
                }

                try {
                    const response = await fetch('/api/auth.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'send_verification',
                            phone: phone
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showSuccess('register-success', 'Код подтверждения отправлен');
                        verificationStep.style.display = 'block';
                    } else {
                        showError('register-error', data.error || 'Ошибка отправки кода');
                    }
                } catch (error) {
                    showError('register-error', 'Ошибка сети');
                }
            });

            loginBtn.addEventListener('click', async function() {
                const identifier = loginIdentifier.value.trim();
                const password = loginPassword.value;

                if (!identifier || !password) {
                    showError('login-error', 'Введите логин и пароль');
                    return;
                }

                try {
                    const response = await fetch('/api/auth.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'login',
                            identifier: identifier,
                            password: password
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('user', JSON.stringify(data.user));
                        window.location.href = 'messenger.html';
                    } else {
                        showError('login-error', data.error || 'Неверные данные');
                    }
                } catch (error) {
                    showError('login-error', 'Ошибка сети');
                }
            });

            registerBtn.addEventListener('click', async function() {
                const phone = registerPhone.value.trim();
                const email = registerEmail.value.trim();
                const password = registerPassword.value;
                const firstName = registerFirstName.value.trim();
                const lastName = registerLastName.value.trim();
                const verificationCodeValue = verificationCode.value.trim();

                if (!firstName || !lastName || !email || !password || !verificationCodeValue) {
                    showError('register-error', 'Заполните все поля');
                    return;
                }

                try {
                    const response = await fetch('/api/auth.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'register',
                            phone: phone,
                            email: email,
                            password: password,
                            first_name: firstName,
                            last_name: lastName,
                            verification_code: verificationCodeValue
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('user', JSON.stringify(data.user));
                        window.location.href = 'messenger.html';
                    } else {
                        showError('register-error', data.error || 'Ошибка регистрации');
                    }
                } catch (error) {
                    showError('register-error', 'Ошибка сети');
                }
            });

            telegramLoginBtn.addEventListener('click', function() {
                alert('Telegram login будет реализован отдельно');
            });

            // Вспомогательные функции
            function validatePhone(phone) {
                const cleaned = phone.replace(/\D/g, '');
                return cleaned.length >= 10;
            }

            function showError(elementId, message) {
                const element = document.getElementById(elementId);
                element.textContent = message;
                element.style.display = 'block';
                
                // Скрываем через 5 секунд
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }

            function showSuccess(elementId, message) {
                const element = document.getElementById(elementId);
                element.textContent = message;
                element.style.display = 'block';
                
                // Скрываем через 5 секунд
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        });
    </script>
</body>
</html>