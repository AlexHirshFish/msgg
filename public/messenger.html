<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Messenger</title>
    
    <!-- VKUI CSS -->
    <link rel="stylesheet" href="https://unpkg.com/@vkontakte/vkui/dist/vkui.css">
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        
        #root {
            height: 100vh;
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 8px;
        }
        
        .message-sender {
            background-color: #2688eb;
            color: white;
            margin-left: auto;
        }
        
        .message-receiver {
            background-color: #f0f1f3;
            color: #000;
        }
        
        .voice-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            background-color: #f0f1f3;
            border-radius: 18px;
            cursor: pointer;
        }
        
        .attachment-preview {
            max-width: 200px;
            border-radius: 8px;
            margin-top: 8px;
        }
        
        .online-status {
            width: 12px;
            height: 12px;
            background-color: #4bb34b;
            border-radius: 50%;
            border: 2px solid white;
            position: absolute;
            bottom: 0;
            right: 0;
        }
        
        .typing-indicator {
            font-style: italic;
            color: #818c99;
            font-size: 14px;
            padding: 8px 16px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- VKUI -->
    <script src="https://unpkg.com/@vkontakte/vkui/dist/vkui.js"></script>

    <script type="text/babel">
        const { 
            AdaptivityProvider, 
            ConfigProvider, 
            AppRoot, 
            SplitLayout, 
            SplitCol, 
            SplitPane,
            View,
            Panel,
            PanelHeader,
            PanelHeaderBack,
            Group,
            List,
            Cell,
            Header,
            Div,
            SimpleCell,
            Avatar,
            Badge,
            IconButton,
            FixedLayout,
            HorizontalScroll,
            Tabs,
            Tab,
            Placeholder,
            Spinner,
            Button,
            Input,
            FormItem,
            FormLayout,
            Textarea,
            ModalRoot,
            ModalPage,
            ModalPageHeader,
            withModalRootContext
        } = VKUI;

        const Icon28MessageOutline = VKIcons.Icon28MessageOutline;
        const Icon28Users3Outline = VKIcons.Icon28Users3Outline;
        const Icon28SearchOutline = VKIcons.Icon28SearchOutline;
        const Icon28AddOutline = VKIcons.Icon28AddOutline;
        const Icon28AttachOutline = VKIcons.Icon28AttachOutline;
        const Icon28MicrophoneOutline = VKIcons.Icon28MicrophoneOutline;
        const Icon28Send = VKIcons.Icon28Send;
        const Icon28MoreHorizontal = VKIcons.Icon28MoreHorizontal;
        const Icon24Chevron = VKIcons.Icon24Chevron;
        const Icon28CameraOutline = VKIcons.Icon28CameraOutline;
        const Icon28DocumentOutline = VKIcons.Icon28DocumentOutline;

        class MessengerApp extends React.Component {
            constructor(props) {
                super(props);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                const token = localStorage.getItem('token');
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                
                this.state = {
                    activeView: token ? 'chats' : 'login',
                    currentUser: user,
                    token: token,
                    chats: [],
                    contacts: [],
                    messages: {},
                    currentChatId: null,
                    newMessage: '',
                    isRecording: false,
                    recordingTime: 0,
                    modal: null,
                    isLoading: false,
                    searchQuery: '',
                    searchResults: [],
                    activeTab: 'chats',
                    showFilePicker: false,
                    mediaRecorder: null,
                    audioChunks: []
                };
                
                if (token) {
                    this.loadChats();
                    this.loadContacts();
                }
            }

            componentDidMount() {
                if (!this.state.token) {
                    window.location.href = 'login.html';
                }
            }

            loadChats = async () => {
                this.setState({ isLoading: true });
                
                try {
                    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç API –≤—ã–∑–æ–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤
                    // –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                    const chats = [
                        {
                            id: 1,
                            name: '–ê–ª–µ–∫—Å–µ–π –ü–µ—Ç—Ä–æ–≤',
                            avatar: 'https://sun9-71.userapi.com/s/v1/if1/NVdDJiBmK4J8mjiKz7wEeN7tX8Q9r0Y1.jpg',
                            lastMessage: '–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?',
                            time: '14:30',
                            unread: 2,
                            online: true
                        },
                        {
                            id: 2,
                            name: '–ú–∞—Ä–∏—è –ò–≤–∞–Ω–æ–≤–∞',
                            avatar: 'https://sun9-59.userapi.com/s/v1/if1/9Y8aBcDeFgHiJkLmNoPqRsTuVwXyZ123.jpg',
                            lastMessage: '–û—Ç–ø—Ä–∞–≤–∏–ª–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã',
                            time: '12:15',
                            unread: 0,
                            online: false
                        }
                    ];
                    
                    this.setState({ chats, isLoading: false });
                } catch (error) {
                    console.error('Error loading chats:', error);
                    this.setState({ isLoading: false });
                }
            };

            loadContacts = async () => {
                try {
                    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç API –≤—ã–∑–æ–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
                    const contacts = [
                        {
                            id: 1,
                            first_name: '–ê–ª–µ–∫—Å–µ–π',
                            last_name: '–ü–µ—Ç—Ä–æ–≤',
                            phone: '+7 999 123-45-67',
                            avatar: 'https://sun9-71.userapi.com/s/v1/if1/NVdDJiBmK4J8mjiKz7wEeN7tX8Q9r0Y1.jpg'
                        },
                        {
                            id: 2,
                            first_name: '–ú–∞—Ä–∏—è',
                            last_name: '–ò–≤–∞–Ω–æ–≤–∞',
                            phone: '+7 999 765-43-21',
                            avatar: 'https://sun9-59.userapi.com/s/v1/if1/9Y8aBcDeFgHiJkLmNoPqRsTuVwXyZ123.jpg'
                        }
                    ];
                    
                    this.setState({ contacts });
                } catch (error) {
                    console.error('Error loading contacts:', error);
                }
            };

            loadMessages = async (chatId) => {
                try {
                    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç API –≤—ã–∑–æ–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
                    const messages = [
                        {
                            id: 1,
                            sender_id: 2,
                            content: '–ü—Ä–∏–≤–µ—Ç!',
                            type: 'text',
                            created_at: '2024-01-01 14:30:00'
                        },
                        {
                            id: 2,
                            sender_id: this.state.currentUser.id,
                            content: '–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?',
                            type: 'text',
                            created_at: '2024-01-01 14:31:00'
                        }
                    ];
                    
                    this.setState(prevState => ({
                        messages: {
                            ...prevState.messages,
                            [chatId]: messages
                        }
                    }));
                } catch (error) {
                    console.error('Error loading messages:', error);
                }
            };

            sendMessage = async () => {
                if (!this.state.newMessage.trim() || !this.state.currentChatId) return;
                
                const message = {
                    id: Date.now(),
                    sender_id: this.state.currentUser.id,
                    content: this.state.newMessage,
                    type: 'text',
                    created_at: new Date().toISOString()
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å—Ç–µ–π—Ç
                this.setState(prevState => ({
                    messages: {
                        ...prevState.messages,
                        [prevState.currentChatId]: [
                            ...(prevState.messages[prevState.currentChatId] || []),
                            message
                        ]
                    },
                    newMessage: ''
                }));
                
                // –ó–¥–µ—Å—å –±—É–¥–µ—Ç API –≤—ã–∑–æ–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
                try {
                    // await fetch('/api/messages/send', {...})
                } catch (error) {
                    console.error('Error sending message:', error);
                }
            };

            startRecording = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const mediaRecorder = new MediaRecorder(stream);
                    const audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        this.uploadVoiceMessage(audioBlob);
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    
                    this.setState({ 
                        isRecording: true, 
                        recordingTime: 0,
                        mediaRecorder,
                        audioChunks
                    });
                    
                    // –°–∏–º—É–ª—è—Ü–∏—è –∑–∞–ø–∏—Å–∏
                    this.recordingInterval = setInterval(() => {
                        this.setState(prevState => ({
                            recordingTime: prevState.recordingTime + 1
                        }));
                    }, 1000);
                } catch (error) {
                    console.error('Error accessing microphone:', error);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
                }
            };

            stopRecording = () => {
                clearInterval(this.recordingInterval);
                
                if (this.state.mediaRecorder && this.state.mediaRecorder.state === 'recording') {
                    this.state.mediaRecorder.stop();
                }
                
                this.setState({ isRecording: false, recordingTime: 0 });
            };

            uploadVoiceMessage = async (audioBlob) => {
                if (!this.state.currentChatId) return;
                
                const formData = new FormData();
                formData.append('voice', audioBlob, 'voice-message.wav');
                formData.append('chat_id', this.state.currentChatId);
                formData.append('duration', this.state.recordingTime);
                
                try {
                    const response = await fetch('/api/media.php?action=upload_voice', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.state.token}`
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // –î–æ–±–∞–≤–ª—è–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å—Ç–µ–π—Ç
                        this.setState(prevState => ({
                            messages: {
                                ...prevState.messages,
                                [prevState.currentChatId]: [
                                    ...(prevState.messages[prevState.currentChatId] || []),
                                    data.message
                                ]
                            }
                        }));
                    } else {
                        console.error('Error uploading voice message:', data.error);
                    }
                } catch (error) {
                    console.error('Error uploading voice message:', error);
                }
            };

            handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file || !this.state.currentChatId) return;
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('chat_id', this.state.currentChatId);
                
                try {
                    const response = await fetch('/api/media.php?action=upload_file', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.state.token}`
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å—Ç–µ–π—Ç
                        this.setState(prevState => ({
                            messages: {
                                ...prevState.messages,
                                [prevState.currentChatId]: [
                                    ...(prevState.messages[prevState.currentChatId] || []),
                                    data.message
                                ]
                            }
                        }));
                    } else {
                        console.error('Error uploading file:', data.error);
                        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + data.error);
                    }
                } catch (error) {
                    console.error('Error uploading file:', error);
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
                }
                
                // –û—á–∏—â–∞–µ–º input
                event.target.value = '';
            };

            formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            openChat = (chatId) => {
                this.setState({ currentChatId: chatId });
                this.loadMessages(chatId);
            };

            logout = () => {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            };

            searchUsersByPhone = async (phone) => {
                this.setState({ isLoading: true });
                
                try {
                    const response = await fetch(`/api/users.php?action=search_by_phone&phone=${encodeURIComponent(phone)}`, {
                        headers: {
                            'Authorization': `Bearer ${this.state.token}`
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.setState({ searchResults: data.users });
                        return data.users;
                    } else {
                        console.error('Error searching users:', data.error);
                        this.setState({ searchResults: [] });
                        return [];
                    }
                } catch (error) {
                    console.error('Error searching users:', error);
                    this.setState({ searchResults: [] });
                    return [];
                } finally {
                    this.setState({ isLoading: false });
                }
            };

            searchUsersByName = async (query) => {
                this.setState({ isLoading: true });
                
                try {
                    const response = await fetch(`/api/users.php?action=search_by_name&query=${encodeURIComponent(query)}`, {
                        headers: {
                            'Authorization': `Bearer ${this.state.token}`
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.setState({ searchResults: data.users });
                        return data.users;
                    } else {
                        console.error('Error searching users:', data.error);
                        this.setState({ searchResults: [] });
                        return [];
                    }
                } catch (error) {
                    console.error('Error searching users:', error);
                    this.setState({ searchResults: [] });
                    return [];
                } finally {
                    this.setState({ isLoading: false });
                }
            };

            addContact = async (userId) => {
                try {
                    const response = await fetch('/api/contacts.php?action=add_contact', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.state.token}`
                        },
                        body: JSON.stringify({
                            contact_user_id: userId
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('–ö–æ–Ω—Ç–∞–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω');
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
                        this.loadContacts();
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + data.error);
                    }
                } catch (error) {
                    console.error('Error adding contact:', error);
                    alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞');
                }
            };

            renderChatsList = () => (
                <Group>
                    {this.state.chats.map(chat => (
                        <SimpleCell
                            key={chat.id}
                            before={
                                <div style={{ position: 'relative' }}>
                                    <Avatar src={chat.avatar} size={48} />
                                    {chat.online && <div className="online-status"></div>}
                                </div>
                            }
                            after={
                                <>
                                    <Text style={{ color: '#818c99', fontSize: '13px' }}>
                                        {chat.time}
                                    </Text>
                                    {chat.unread > 0 && (
                                        <Badge mode="prominent">{chat.unread}</Badge>
                                    )}
                                </>
                            }
                            subtitle={chat.lastMessage}
                            onClick={() => this.openChat(chat.id)}
                        >
                            {chat.name}
                        </SimpleCell>
                    ))}
                </Group>
            );

            renderContactsList = () => (
                <Group>
                    <Div>
                        <Button 
                            size="l" 
                            mode="secondary" 
                            stretched
                            onClick={() => this.setState({ activeView: 'search_users' })}
                        >
                            –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                        </Button>
                    </Div>
                    
                    {this.state.contacts.map(contact => (
                        <SimpleCell
                            key={contact.id}
                            before={<Avatar src={contact.avatar} size={48} />}
                            after={<Icon24Chevron />}
                            onClick={() => this.openChat(contact.id)}
                        >
                            {`${contact.first_name} ${contact.last_name}`}
                            <Text style={{ color: '#818c99', fontSize: '13px' }}>
                                {contact.phone}
                            </Text>
                        </SimpleCell>
                    ))}
                </Group>
            );

            renderSearchUsers = () => (
                <Group>
                    <Div>
                        <Button 
                            size="l" 
                            mode="tertiary" 
                            onClick={() => this.setState({ activeView: 'chats' })}
                        >
                            –ù–∞–∑–∞–¥
                        </Button>
                    </Div>
                    
                    <FormItem top="–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
                        <Input
                            type="tel"
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"
                            value={this.state.searchQuery}
                            onChange={(e) => this.setState({ searchQuery: e.target.value })}
                            after={
                                <Button
                                    mode="tertiary"
                                    onClick={async () => {
                                        await this.searchUsersByPhone(this.state.searchQuery);
                                        this.setState({ activeView: 'search_users' });
                                    }}
                                >
                                    –ù–∞–π—Ç–∏
                                </Button>
                            }
                        />
                    </FormItem>
                    
                    <FormItem top="–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞">
                        {this.state.searchResults && this.state.searchResults.length > 0 ? (
                            this.state.searchResults.map(user => (
                                <SimpleCell
                                    key={user.id}
                                    before={<Avatar src={user.avatar} size={48} />}
                                    after={
                                        <Button
                                            mode="primary"
                                            size="s"
                                            onClick={() => this.addContact(user.id)}
                                        >
                                            –î–æ–±–∞–≤–∏—Ç—å
                                        </Button>
                                    }
                                >
                                    {`${user.first_name} ${user.last_name}`}
                                    <Text style={{ color: '#818c99', fontSize: '13px' }}>
                                        {user.phone}
                                    </Text>
                                </SimpleCell>
                            ))
                        ) : (
                            <Div style={{ textAlign: 'center', color: '#818c99' }}>
                                –ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
                            </Div>
                        )}
                    </FormItem>
                </Group>
            );

            renderMessageContent = (message) => {
                switch (message.type) {
                    case 'text':
                        return message.content;
                    
                    case 'voice':
                        return (
                            <div className="voice-message" onClick={() => this.playVoiceMessage(message.file_path)}>
                                <Icon28MicrophoneOutline />
                                <span>–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</span>
                                {message.duration && <span>({Math.ceil(message.duration)} —Å–µ–∫)</span>}
                            </div>
                        );
                    
                    case 'image':
                        return (
                            <div>
                                <div>{message.content}</div>
                                <img 
                                    src={`/api/media.php?action=download_file&path=${encodeURIComponent(message.file_path)}`} 
                                    alt="Attachment" 
                                    className="attachment-preview"
                                    style={{ maxWidth: '200px', borderRadius: '8px', marginTop: '8px' }}
                                />
                            </div>
                        );
                    
                    case 'file':
                        return (
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                <Icon28DocumentOutline />
                                <div>
                                    <div>{message.file_name}</div>
                                    <div style={{ fontSize: '12px', opacity: 0.7 }}>
                                        {(message.file_size / 1024).toFixed(1)} KB
                                    </div>
                                </div>
                                <Button 
                                    mode="tertiary" 
                                    size="s"
                                    onClick={() => this.downloadFile(message.file_path, message.file_name)}
                                >
                                    –°–∫–∞—á–∞—Ç—å
                                </Button>
                            </div>
                        );
                    
                    default:
                        return message.content;
                }
            };

            playVoiceMessage = (filePath) => {
                // –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                console.log('Playing voice message:', filePath);
                alert('–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø–æ–∑–∂–µ');
            };

            downloadFile = (filePath, fileName) => {
                const link = document.createElement('a');
                link.href = `/api/media.php?action=download_file&path=${encodeURIComponent(filePath)}`;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            renderMessages = () => {
                const messages = this.state.messages[this.state.currentChatId] || [];
                
                return (
                    <Group>
                        <Div style={{ minHeight: 'calc(100vh - 200px)' }}>
                            {messages.map(message => (
                                <div
                                    key={message.id}
                                    className={`message-bubble ${
                                        message.sender_id === this.state.currentUser.id 
                                            ? 'message-sender' 
                                            : 'message-receiver'
                                    }`}
                                    style={{
                                        marginLeft: message.sender_id === this.state.currentUser.id ? 'auto' : 0,
                                        marginRight: message.sender_id !== this.state.currentUser.id ? 'auto' : 0
                                    }}
                                >
                                    {this.renderMessageContent(message)}
                                    <div style={{ 
                                        fontSize: '11px', 
                                        opacity: 0.7, 
                                        marginTop: '4px',
                                        textAlign: message.sender_id === this.state.currentUser.id ? 'right' : 'left'
                                    }}>
                                        {new Date(message.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                    </div>
                                </div>
                            ))}
                            
                            {this.state.isRecording && (
                                <Div className="typing-indicator">
                                    üé§ –ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è... {this.formatTime(this.state.recordingTime)}
                                </Div>
                            )}
                        </Div>
                        
                        <FixedLayout vertical="bottom">
                            <Div style={{ backgroundColor: 'white', padding: '8px' }}>
                                <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                                    <IconButton onClick={() => document.getElementById('file-input').click()}>
                                        <Icon28AttachOutline />
                                    </IconButton>
                                    <IconButton onClick={() => document.getElementById('image-input').click()}>
                                        <Icon28CameraOutline />
                                    </IconButton>
                                    <input 
                                        type="file" 
                                        id="file-input" 
                                        style={{ display: 'none' }} 
                                        onChange={this.handleFileUpload}
                                        accept=".pdf,.doc,.docx,.txt"
                                    />
                                    <input 
                                        type="file" 
                                        id="image-input" 
                                        style={{ display: 'none' }} 
                                        onChange={this.handleFileUpload}
                                        accept="image/*"
                                    />
                                    
                                    {this.state.isRecording ? (
                                        <Button
                                            mode="destructive"
                                            size="l"
                                            stretched
                                            onClick={this.stopRecording}
                                        >
                                            –û—Ç–º–µ–Ω–∏—Ç—å
                                        </Button>
                                    ) : (
                                        <Textarea
                                            value={this.state.newMessage}
                                            onChange={(e) => this.setState({ newMessage: e.target.value })}
                                            placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."
                                            onKeyDown={(e) => {
                                                if (e.key === 'Enter' && !e.shiftKey) {
                                                    e.preventDefault();
                                                    this.sendMessage();
                                                }
                                            }}
                                        />
                                    )}
                                    
                                    <IconButton
                                        onClick={this.state.isRecording ? this.stopRecording : this.startRecording}
                                    >
                                        <Icon28MicrophoneOutline 
                                            style={{ 
                                                color: this.state.isRecording ? '#e64646' : '#2688eb' 
                                            }} 
                                        />
                                    </IconButton>
                                    
                                    {!this.state.isRecording && (
                                        <IconButton 
                                            disabled={!this.state.newMessage.trim()}
                                            onClick={this.sendMessage}
                                        >
                                            <Icon28Send />
                                        </IconButton>
                                    )}
                                </div>
                            </Div>
                        </FixedLayout>
                    </Group>
                );
            };

            render() {
                return (
                    <ConfigProvider>
                        <AdaptivityProvider>
                            <AppRoot>
                                <SplitLayout
                                    header={<PanelHeader separator={false} />}
                                    style={{ justifyContent: 'center' }}
                                >
                                    <SplitCol minWidth={320} width="100%" maxWidth={480}>
                                        {this.state.currentChatId ? (
                                            <View activePanel="messages">
                                                <Panel id="messages">
                                                    <PanelHeader
                                                        before={
                                                            <PanelHeaderBack 
                                                                onClick={() => this.setState({ currentChatId: null })}
                                                            />
                                                        }
                                                        after={
                                                            <IconButton onClick={() => this.logout()}>
                                                                <Icon28MoreHorizontal />
                                                            </IconButton>
                                                        }
                                                    >
                                                        –ß–∞—Ç
                                                    </PanelHeader>
                                                    {this.renderMessages()}
                                                </Panel>
                                            </View>
                                        ) : (
                                            <View activePanel={this.state.activeView}>
                                                <Panel id="chats">
                                                    <PanelHeader
                                                        before={
                                                            <IconButton onClick={() => this.logout()}>
                                                                <Icon28MoreHorizontal />
                                                            </IconButton>
                                                        }
                                                    >
                                                        Messenger
                                                    </PanelHeader>
                                                    
                                                    <Tabs>
                                                        <Tab
                                                            selected={this.state.activeTab === 'chats'}
                                                            onClick={() => this.setState({ activeTab: 'chats' })}
                                                        >
                                                            <Icon28MessageOutline />
                                                            –ß–∞—Ç—ã
                                                        </Tab>
                                                        <Tab
                                                            selected={this.state.activeTab === 'contacts'}
                                                            onClick={() => this.setState({ activeTab: 'contacts' })}
                                                        >
                                                            <Icon28Users3Outline />
                                                            –ö–æ–Ω—Ç–∞–∫—Ç—ã
                                                        </Tab>
                                                    </Tabs>
                                                    
                                                    {this.state.isLoading ? (
                                                        <Div style={{ display: 'flex', justifyContent: 'center', padding: '20px' }}>
                                                            <Spinner size="large" />
                                                        </Div>
                                                    ) : this.state.activeTab === 'chats' ? (
                                                        this.renderChatsList()
                                                    ) : (
                                                        this.renderContactsList()
                                                    )}
                                                </Panel>
                                                
                                                <Panel id="search_users">
                                                    <PanelHeader
                                                        before={
                                                            <PanelHeaderBack 
                                                                onClick={() => this.setState({ activeView: 'chats', activeTab: 'contacts' })}
                                                            />
                                                        }
                                                    >
                                                        –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                                                    </PanelHeader>
                                                    {this.renderSearchUsers()}
                                                </Panel>
                                            </View>
                                        )}
                                    </SplitCol>
                                </SplitLayout>
                                
                                <ModalRoot activeModal={this.state.modal}>
                                    {/* –ó–¥–µ—Å—å –±—É–¥—É—Ç –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */}
                                </ModalRoot>
                            </AppRoot>
                        </AdaptivityProvider>
                    </ConfigProvider>
                );
            }
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<MessengerApp />);
    </script>
</body>
</html>